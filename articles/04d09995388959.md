---
title: "gitbucket-drawio-plugin ã‚’å‹•ãã‚ˆã†ã«ã—ãŸã„"
emoji: "ğŸ‘"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["GitBucket", "Scala", "JavaScript", "drawio"]
published: true
---

ã¾ã ã€æ›¸ãã‹ã‘ã§ã™ãŒã€å…¬é–‹ã—ã¾ã™ã€‚

## ç­†è€…ã®ç’°å¢ƒ

ç’°å¢ƒ,ãƒãƒ¼ã‚¸ãƒ§ãƒ³
Windows,11
GitBucket,4.43.0

## gitbucket-drawio-plugin-0.1.0 ã‚’å°å…¥ã—ã¦ã¿ãŸã‘ã©â€¦

[gitbucket-drawio-plugin](https://github.com/onukura/gitbucket-drawio-plugin)

æœ€è¿‘ã€[draw.io](https://app.diagrams.net/) ã§ä½œæˆã—ãŸãƒ•ã‚¡ã‚¤ãƒ«ã§è©¦ã—ã¦ã¿ãŸãŒã€ã†ã¾ãè¡¨ç¤ºã•ã‚Œãšã€‚

![](https://storage.googleapis.com/zenn-user-upload/e3c4697f6f71-20250709.png)

é–‹ç™ºè€…ãƒ„ãƒ¼ãƒ«ã§ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‚’è¦‹ã¦ã¿ã‚‹ã¨ä»¥ä¸‹ã®ã‚ˆã†ãªã‚¨ãƒ©ãƒ¼ãŒã€‚

```
Object { message: "Not a diagram file", toString: toString() }
viewer.min.js:4083:236
```

## ã¨ã„ã†ã“ã¨ã§ä¿®æ­£ã«æŒ‘æˆ¦

Scala ä½¿ã£ãŸã“ã¨ãªã„ã‘ã©â€¦ã€‚

### viewer.min.js ã‚’ upstream ã®æœ€æ–°ç‰ˆã«æ›´æ–°

`src\main\resources\drawio\assets\viewer.min.js`  ã‚’ [upstream](https://github.com/jgraph/drawio/) ã® [drawio/src/main/webapp/js/viewer.min.js](https://github.com/jgraph/drawio/blob/dev/src/main/webapp/js/viewer.min.js)  ã®ã‚‚ã®ã«å…¥ã‚Œæ›¿ãˆãŸã€‚

### ä¿®æ­£ã®æ–¹å‘æ€§ã‚’èª¿æŸ»

ä¿®æ­£ã«å½“ãŸã£ã¦ã¯ã€[Viewing a .drawio file in an HTML document Â· jgraph/drawio Â· Discussion #3430](https://github.com/jgraph/drawio/discussions/3430) ã‚’å‚è€ƒã«ã—ãŸã€‚

ä¸Šè¨˜ãƒšãƒ¼ã‚¸ã«ã‚ˆã‚‹ã¨

```html
<div class="mxgraph" style="max-width:100%;border:1px solid transparent;" data-mxgraph="{&quot;highlight&quot;:&quot;#0000ff&quot;,&quot;nav&quot;:true,&quot;resize&quot;:true,&quot;toolbar&quot;:&quot;zoom layers lightbox&quot;,&quot;edit&quot;:&quot;_blank&quot;,&quot;xml&quot;:&quot;&lt;mxfile userAgent=\&quot;Mozilla/5.0 (Macintosh; Intel Mac OS X 10_13_4) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/66.0.3359.181 Safari/537.36\&quot; version=\&quot;8.6.5\&quot; editor=\&quot;www.draw.io\&quot;&gt;&lt;diagram id=\&quot;8d8df455-cfe5-311a-13e6-259b44eb4504\&quot; name=\&quot;Page-1\&quot;&gt;jZM7c4MwDIB/jfdgU0rX0LQd2omhswsK9sVgzjEB+usrsM3jcrkrC9InybIeJiyrh3fDW/GlS1CEHsqBsFdCaURZir+JjJ5EcexIZWTp2Qpy+QseHjztZAnXnaPVWlnZ7mGhmwYKu2PcGN3v3c5a7bO2vII7kBdc3dNvWVrhaEqfV/4BshIhc5S8OMsPLy6V0V3j8xHKzvPnzDUPZ/lCr4KXut8gdiIsM1pbJ9VDBmpqbmibi3t7YF3ubaCx/wmgLuDGVQfhxonC0GNrAMVqEgMqcNCBfcINDMcyM0aOqWnABi9MtnXc4N2Rc/V2DB3vhbSQt7yY9B7XCp2ErRVq0eKPKS0MD0uNlgbiZoKuwZoRXULAk+95WMrY6/064SjMRWymm3jG/VJVy9FrY1HwvQ3qOsPZtnkp7PQH&lt;/diagram&gt;&lt;/mxfile&gt;&quot;}"></div>
```

ã®ã‚ˆã†ãªã‚¿ã‚°ãŒå­˜åœ¨ã™ã‚‹çŠ¶æ…‹ã§

```javascript
window.GraphViewer.processElements();
```

ã‚’å‘¼ã³å‡ºã™ã¨SVGç”»åƒã¨ã—ã¦è¡¨ç¤ºã§ãã‚‹ã‚ˆã†ã§ã‚ã‚‹ã€‚

å…ˆã»ã©ã®ã‚¿ã‚°ã®  `data-mxgraph` å±æ€§ã«ã¯ã€JSON ã‚’æ–‡å­—åˆ—åŒ–ã—ãŸã‚‚ã®ãŒå…¥ã£ã¦ã„ã‚‹ã‚ˆã†ã§ã‚ã‚‹ã€‚

ãã® JSON ã®æœ€å¾Œã®å±æ€§ã«ã¯ã€draw.io ã® XML ãƒ‡ãƒ¼ã‚¿ãŒå…¥ã£ã¦ã„ã‚‹ã‚ˆã†ã§ã‚ã‚‹ã€‚

### ã¾ãšã¯ XML ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—ã—ã¦ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆæ¸¡ã™ã‚ˆã†ã«ä¿®æ­£

`src\main\scala\DrawioRenderer.scala` ã® `toHtml` é–¢æ•°ã‚’ä»¥ä¸‹ã®ã‚ˆã†ã«ä¿®æ­£ã—ãŸã€‚

```scala
  def toHtml(content: String)(implicit context: Context): String = {
    val path = context.baseUrl
    val data = content.replaceAll("&", "&amp;")
                      .replaceAll("'", "&#x27;")
                      .replaceAll("`", "&#x60;")
                      .replaceAll("\"", "&quot;")
                      .replaceAll("<", "&lt;")
                      .replaceAll(">", "&gt;")

    s"""
       |<link rel="stylesheet" type="text/css" href="$path/plugin-assets/drawio/drawio-renderer.css">
       |<script src="$path/plugin-assets/drawio/viewer.min.js"></script>
       |<script src="$path/plugin-assets/drawio/drawio-renderer.js"></script>
       |<div class="mxgraph" data-diagram-data="$data"></div>
       |""".stripMargin

  }
```

ã“ã‚Œã§ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ã«ä»¥ä¸‹ã®ã‚ˆã†ãªã‚¿ã‚°ãŒæ¸¡ã•ã‚Œã‚‹ã‚ˆã†ã«ãªã£ãŸã€‚

```html
<div class="mxgraph" data-diagram-data="ã“ã“ã« XML ã‚’ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—ã—ãŸå†…å®¹"></div>
```

### æ¸¡ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ã‚’ JavaScript ã§æ“ä½œã™ã‚‹

`src\main\resources\drawio\assets\drawio-renderer.js` ã‚’ä»¥ä¸‹ã®ã‚ˆã†ã«ä¿®æ­£ã—ãŸã€‚

```javascript
// from https://github.com/jgraph/drawio/discussions/3430
function createMxGraphData(xml, idx = new Date().getTime()) {
    return {
        editable: false,
        highlight: "#0000ff",
        nav: false,
        toolbar: null,
        edit: null,
        resize: true,
        lightbox: "open",
        xml,
    };
}

window.addEventListener("load", function(){
    div = document.querySelector(".mxgraph") 
    xml = div.getAttribute("data-diagram-data")
    mxGraphData = createMxGraphData(xml); 
    json = JSON.stringify(mxGraphData) 
    div.setAttribute('data-mxgraph', json)
    window.GraphViewer.processElements();
})
```

`createMxGraphData` é–¢æ•°ã¯ã€ä¿®æ­£ã®å‚è€ƒã«ã—ãŸãƒšãƒ¼ã‚¸ã‹ã‚‰æ‹å€Ÿã—ã¦ããŸã€‚

`window` ã® `load` ã‚¤ãƒ™ãƒ³ãƒˆå†…ã§ä»¥ä¸‹ã®å‡¦ç†ã‚’è¡Œã†ã€‚

```javascript
    div = document.querySelector(".mxgraph") 
```

ã‚¯ãƒ©ã‚¹ `mxgraph` ã® `<div>` ã‚¿ã‚°ã‚’å–å¾—ã™ã‚‹ã€‚

```javascript
    xml = div.getAttribute("data-diagram-data")
```

å–å¾—ã—ãŸã‚¿ã‚°ã® `data-diagram-data` å±æ€§ã‹ã‚‰ã€XML ã‚’å–å¾—ã™ã‚‹ã€‚

```javascript
    mxGraphData = createMxGraphData(xml); 
```

`createMxGraphData` é–¢æ•°ã«ã‚ˆã‚Šã€JSON ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã«å¤‰æ›ã™ã‚‹ã€‚ 

```javascript
    json = JSON.stringify(mxGraphData) 
```

JSON ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‹ã‚‰ã€JSON æ–‡å­—åˆ—ã«å¤‰æ›ã™ã‚‹ã€‚

```javascript
    div.setAttribute('data-mxgraph', json)
```

å…ƒã®ã‚¿ã‚°ã« `data-mxgraph` å±æ€§ã‚’è¿½åŠ ã—ã€JSON æ–‡å­—åˆ—ã‚’è¨­å®šã™ã‚‹ã€‚

```javascript
    window.GraphViewer.processElements();
```

ã‚¿ã‚°ã‹ã‚‰ã€SVG ç”»åƒã‚’ç”Ÿæˆã™ã‚‹ã€‚

### ãƒ“ãƒ«ãƒ‰

ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³æƒ…å ±ã‚’ä¸Šã’ãŸã†ãˆã§ãƒ“ãƒ«ãƒ‰ã‚’è¡Œã£ãŸã€‚

#### ccoursier-cli ã§ Java 17 ç’°å¢ƒã‚’æº–å‚™

Java 17 ã®ç’°å¢ƒã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã€‚

```
cs java --jvm 17 --setup
```

Java 17 ã®ç’°å¢ƒã‚’ä½¿ç”¨ã™ã‚‹ãŸã‚ã®ç’°å¢ƒå¤‰æ•°ã‚’å–å¾—ã€‚

```
cs java --env --jvm 17
```

çµæœã‚’å®Ÿè¡Œã—ã€Java 17 ã‚’æœ‰åŠ¹ã«ã—ãŸã€‚

#### jar ã®ç”Ÿæˆ

```
sbt assembly
```

`target\scala-2.13` ã« jar ãƒ•ã‚¡ã‚¤ãƒ«ãŒç”Ÿæˆã•ã‚Œã‚‹ã®ã§ãƒ›ãƒ¼ãƒ ã® `.gitbucket\plugins` ã«é…ç½®ã€‚

## ã¨ã‚Šã‚ãˆãšç„¡äº‹ã«è¡¨ç¤ºã§ããŸ

![](https://storage.googleapis.com/zenn-user-upload/729f2f2506a5-20250709.png)

## ã“ã“ã¾ã§ã®æˆæœç‰©ã‚’ãƒ—ãƒ¬ãƒªãƒªãƒ¼ã‚¹ã—ãŸ

[Release Pre release 0.2.0a Â· yasumichi/gitbucket-drawio-plugin](https://github.com/yasumichi/gitbucket-drawio-plugin/releases/tag/0.2.0a)

upstream ã¸ PR ã™ã‚‹ã‹ã€ä»Šå¾Œæ¤œè¨ã€‚