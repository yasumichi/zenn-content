---
title: "mael for VBA ã‚’åˆ—è¨­å®šã«å¯¾å¿œã•ã›ã‚‹"
emoji: "ğŸ‰"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics:
    - VBA
    - mael
    - python
published: true
---
## å‰å›ã®è¨˜äº‹

https://zenn.dev/yasumichi/articles/f818c61e12a574

## è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã‚’è€ƒãˆã‚‹

å‰å›ã®è¨˜äº‹ã§ã‚‚æ›¸ã„ãŸãŒã€YAML ã‚’ãƒ‘ãƒ¼ã‚¹ã™ã‚‹ã®ã¯ã€å°‘ã—éª¨ãŒæŠ˜ã‚Œãã†ãªã®ã§ `config\columns.xlsx` ã¨ã„ã†åå‰ã® Excel ãƒ–ãƒƒã‚¯ã§è¨­å®šã‚’ã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹ã€‚

ä»¥ä¸‹ã®è¨­å®šã¯ã¨ã‚Šã‚ãˆãšå¯¾å¿œã—ãªã„ã€‚

- global
- duplicate_previous_for_blank

ä»¥ä¸‹ã®é …ç›®ã‚’è¨­å®šã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹ã€‚

- Column name
- type (`increment`, `list`, `string`)
- value (`increment` ã®å ´åˆã«ä½¿ç”¨ã™ã‚‹åˆæœŸå€¤)
- alignment (`left`ã€`center`ã€`right`)
- width

### æœ€åˆã«æŒ¿å…¥ã™ã‚‹åˆ—ã®è¨­å®š

ã‚·ãƒ¼ãƒˆ `prepend` ã§è¨­å®šã™ã‚‹ã€‚

![](https://github.com/yasumichi/maelForVBA/blob/main/images/prepend.png?raw=true)

### markdown ãƒ•ã‚¡ã‚¤ãƒ«ã«è¨˜è¿°ã•ã‚Œã¦ã„ã‚‹åˆ—ã®è¨­å®š

ã‚·ãƒ¼ãƒˆ  `column_conditions` ã§è¨­å®šã™ã‚‹ã€‚

![](https://github.com/yasumichi/maelForVBA/blob/main/images/column_conditions.png?raw=true)


### æœ€å¾Œã«è¿½åŠ ã™ã‚‹åˆ—ã®è¨­å®š

ã‚·ãƒ¼ãƒˆ `append` ã§è¨­å®šã™ã‚‹ã€‚

![](https://github.com/yasumichi/maelForVBA/blob/main/images/append.png?raw=true)

## ColumnCondition ã‚¯ãƒ©ã‚¹ã®ä½œæˆ

[mael](https://github.com/KenjiOhtsuka/mael) ã® [mael/column_config.py](https://github.com/KenjiOhtsuka/mael/blob/main/mael/column_config.py)  ã§å®šç¾©ã•ã‚Œã¦ã„ã‚‹ [ColumnCondition](https://github.com/KenjiOhtsuka/mael/blob/main/mael/column_config.py#L28) ã‚¯ãƒ©ã‚¹ã‚’ç§»æ¤ã™ã‚‹ã€‚

```vba
''' <summary>Class ColumnCondition</summary>

Option Explicit

Public value_type As ValueType
Public initial_value As Long
Public width As Double
Public alignment As Long
Public maxCount As Long

''' <summary>Constructor</sammary>
Private Sub Class_Initialize()
    value_type = TYPE_STRING
    initial_value = 1
    width = 8.38
    alignment = xlLeft
    maxCount = 1
End Sub

''' <summary>public initializer</sammary>
''' <params id="title_">column title</param>
''' <params id="type_">column value type</param>
Public Sub Init(vtype As ValueType, width_ As Double, alignment_ As Long)
    value_type = vtype
    width = width_
    alignment = alignment_
End Sub
```

### ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£

|ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£     |å½¹å‰²       |
|----------|---------|
|value_type|åˆ—ã®ç¨®åˆ¥     |
|initial_value| increment ã®åˆæœŸå€¤ |
|alignment |æ°´å¹³æ–¹å‘ã®æ–‡å­—æƒãˆ|
|width     |åˆ—ã®å¹…      |
|maxCount  |listã®æœ€å¤§é …ç›®æ•°(ç‹¬è‡ª)  |

`duplicate_previous_for_blank` ã¯ã€æœªå®Ÿè£…ã€‚

### ãƒ¡ã‚½ãƒƒãƒ‰

|ãƒ¡ã‚½ãƒƒãƒ‰|å½¹å‰²           |
|----|-------------|
|Init|å¤–éƒ¨ã‹ã‚‰ã‚¯ãƒ©ã‚¹ã‚’åˆæœŸåŒ–ã™ã‚‹|

## ColumnConfig ã‚¯ãƒ©ã‚¹ã®ä½œæˆ

[ColumnConfig](https://github.com/KenjiOhtsuka/mael/blob/main/mael/column_config.py#L45)  ã‚¯ãƒ©ã‚¹ã‚’ç§»æ¤ã™ã‚‹ã€‚

ç§»æ¤ã¨è¨€ã„ã¤ã¤ã€çµæ§‹ã€ç‹¬è‡ªå®Ÿè£…ã«ãªã£ã¦ã—ã¾ã£ãŸã€‚

```vba
''' <summary>Class ColumnConfig</summary>
''' <remarks>
''' Requires
''' - Microsoft Scripting Runtime
''' </remarks>

Option Explicit

Public prepend_columns As Scripting.Dictionary
Public conditions As Scripting.Dictionary
Public append_columns As Scripting.Dictionary

''' <summary>default constructor</sammary>
Private Sub Class_Initialize()
    Set prepend_columns = New Scripting.Dictionary
    Set conditions = New Scripting.Dictionary
    Set append_columns = New Scripting.Dictionary
End Sub

''' <summary>list columns</sammary>
Public Function AllConditions() As Scripting.Dictionary
    Dim key As Variant
    Dim dict As New Scripting.Dictionary
    
    For Each key In prepend_columns.Keys
        dict.Add key, prepend_columns.item(key)
    Next
    
    For Each key In conditions.Keys
        dict.Add key, conditions.item(key)
    Next
    
    For Each key In append_columns.Keys
        dict.Add key, append_columns.item(key)
    Next

    Set AllConditions = dict
End Function

''' <summary>parse configuration of columns</sammary>
Public Sub Parse(configPath As String)
    Dim sh As Worksheet
    Dim coldic As Scripting.Dictionary
    Dim rowNumber As Long
    Dim colName As String
    Dim condition As ColumnCondition

    If Right(configPath, 5) <> ".xlsx" Then
        Debug.Print configPath & " is not supported."
        Exit Sub
    End If
    
    If Dir(configPath) = "" Then
        Debug.Print configPath & " is not exists."
        Exit Sub
    End If
    
    Application.ScreenUpdating = False
    
    With Workbooks.Open(configPath)
        With sh
        End With
        For Each sh In .Worksheets
            Set coldic = New Scripting.Dictionary
            With sh
                rowNumber = 2
                Do While .Cells(rowNumber, 1).Value <> ""
                    Set condition = New ColumnCondition
                    colName = .Cells(rowNumber, 1).Value
                    ' value_type
                    Select Case LCase(.Cells(rowNumber, 2).Value)
                    Case "increment"
                        condition.value_type = TYPE_INCREMENT
                        If .Cells(rowNumber, 3).Value <> "" Then
                            condition.initial_value = Val(.Cells(rowNumber, 3).Value)
                        End If
                    Case "list"
                        condition.value_type = TYPE_LIST
                    Case "string"
                        condition.value_type = TYPE_STRING
                    Case Else
                        condition.value_type = TYPE_STRING
                    End Select
                    
                    ' alignment
                    If .Cells(rowNumber, 4).Value <> "" Then
                        Select Case LCase(.Cells(rowNumber, 4).Value)
                        Case "left"
                            condition.alignment = xlLeft
                        Case "center"
                            condition.alignment = xlCenter
                        Case "right"
                            condition.alignment = xlRight
                        Case Else
                            condition.alignment = xlLeft
                        End Select
                    End If
                    
                    ' width
                    If .Cells(rowNumber, 5).Value <> "" Then
                        condition.width = Val(.Cells(rowNumber, 5).Value)
                    End If
                    
                    
                    coldic.Add colName, condition
                    rowNumber = rowNumber + 1
                    Set condition = Nothing
                Loop
                
            End With
            Select Case sh.Name
            Case "prepend"
                Set prepend_columns = coldic
            Case "column_conditions"
                Set conditions = coldic
            Case "append"
                Set append_columns = coldic
            End Select
            Set coldic = Nothing
        Next
        .Close
    End With
    
    Application.ScreenUpdating = True
End Sub
```

### ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£

|ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£     |å½¹å‰²       |
|----------|---------|
|prepend_columns |æœ€åˆã«æŒ¿å…¥ã™ã‚‹åˆ—ã®è¨­å®šã‚’ä¿æŒã™ã‚‹è¾æ›¸     |
|conditions | markdown ãƒ•ã‚¡ã‚¤ãƒ«ã«è¨˜è¿°ã•ã‚Œã¦ã„ã‚‹åˆ—ã®è¨­å®šã‚’ä¿æŒã™ã‚‹è¾æ›¸ |
|append_columns |æœ€å¾Œã«è¿½åŠ ã™ã‚‹åˆ—ã®è¨­å®šã‚’ä¿æŒã™ã‚‹è¾æ›¸ |


### ãƒ¡ã‚½ãƒƒãƒ‰

|ãƒ¡ã‚½ãƒƒãƒ‰|å½¹å‰²           |
|----|-------------|
|AllConditions | ã™ã¹ã¦ã®åˆ—ã®è¨­å®šã‚’å–å¾—ã™ã‚‹ |
|Parse|è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰åˆ—ã®è¨­å®šã‚’èª­ã¿è¾¼ã‚€|

### ãƒ†ã‚¹ãƒˆã‚³ãƒ¼ãƒ‰

å‹•ä½œç¢ºèªç”¨ã®ç°¡å˜ãªãƒ†ã‚¹ãƒˆã‚³ãƒ¼ãƒ‰ã‚’æ›¸ãã€‚

```vba
Sub TestParse()
    Dim config As New ColumnConfig
    Dim filePath As String
    Dim key As Variant
    Dim cond As ColumnCondition
    
    filePath = Application.GetOpenFilename
    
    'Debug.Print Replace(filePath, Dir(filePath), "")
    
    config.Parse (filePath)
    
    For Each key In config.prepend_columns.Keys
        Debug.Print CStr(key)
        Set cond = config.prepend_columns.item(key)
        Debug.Print "- " & cond.value_type
        Debug.Print "- " & cond.initial_value
        Debug.Print "- " & cond.alignment
        Debug.Print "- " & cond.width
    Next
    
    For Each key In config.conditions.Keys
        Debug.Print CStr(key)
        Set cond = config.conditions.item(key)
        Debug.Print "- " & cond.value_type
        Debug.Print "- " & cond.initial_value
        Debug.Print "- " & cond.alignment
        Debug.Print "- " & cond.width
    Next
    
    For Each key In config.append_columns.Keys
        Debug.Print CStr(key)
        Set cond = config.append_columns.item(key)
        Debug.Print "- " & cond.value_type
        Debug.Print "- " & cond.initial_value
        Debug.Print "- " & cond.alignment
        Debug.Print "- " & cond.width
    Next
End Sub
```

ã‚µãƒ³ãƒ—ãƒ«è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã®å ´åˆã¯ã€ä»¥ä¸‹ã®å‡ºåŠ›ãŒå¾—ã‚‰ã‚ŒãŸã€‚

```
No.
- 1
- 1
- -4131
- 8.38
Categories
- 2
- 1
- -4108
- 8.38
Description
- 2
- 1
- -4131
- 50
Expected
- 2
- 1
- -4131
- 50
Result
- 2
- 1
- -4131
- 8.38
Timestamp
- 2
- 1
- -4131
- 8.38
Comment
- 2
- 1
- -4131
- 50
```

## ExcelBuilderModule ã®æ”¹è‰¯

`ColumnConfig` ã‚¯ãƒ©ã‚¹ã®ç”Ÿæˆã¯ã€`Build` ãƒ—ãƒ­ã‚·ãƒ¼ã‚¸ãƒ£ã§è¡Œã„ã€`Convert` ãƒ—ãƒ­ã‚·ãƒ¼ã‚¸ãƒ£ã«æ¸¡ã™ã‚ˆã†ã«ã™ã‚‹ã€‚

`Convert` ãƒ—ãƒ­ã‚·ãƒ¼ã‚¸ãƒ£ã®å®£è¨€ã‚’æ¬¡ã®ã‚ˆã†ã«ä¿®æ­£ã™ã‚‹ã€‚

```vba
Sub Convert(ByVal filePath As String, ByVal config As ColumnConfig)
```

### markdown ã®è¡¨éƒ¨åˆ†ç©ã¿è¾¼ã¿å‡¦ç†ã®æ”¹è‰¯

```vba
        Dim steps As New Collection
        Dim stepDict As New Scripting.Dictionary
        Dim cond As ColumnCondition
        Dim item As StepItem
        Dim itemType As ValueType
        Dim title As String
        Set item = Nothing
        
        itemType = TYPE_STRING
        Do While True
            line = .ReadText(-2)
            
            If .EOS Then
                If Not item Is Nothing Then
                    stepDict.Add item.title, item.GetContent()
                End If
                If stepDict.Count > 0 Then
                    steps.Add stepDict
                End If
                Exit Do
            End If
            
            With New RegExp
                .Pattern = "^\s*---\s*$"
                If .Test(line) Then
                    If Not item Is Nothing Then
                        stepDict.Add item.title, item.GetContent()
                        If itemType = TYPE_LIST Then
                            If config.conditions.item(title).maxCount < item.GetContent().Count Then
                                config.conditions.item(title).maxCount = item.GetContent().Count
                            End If
                        End If
                        Set item = Nothing
                    End If
                    If stepDict.Count > 0 Then
                        steps.Add stepDict
                        Set stepDict = New Scripting.Dictionary
                    End If
                    GoTo CONTINUE
                End If
                
                .Pattern = "^#{3,}\s*(\S.*\S|\S)\s*$"
                Set mc = .Execute(line)
                If mc.Count > 0 Then
                    If Not item Is Nothing Then
                        stepDict.Add item.title, item.GetContent()
                        If itemType = TYPE_LIST Then
                            If config.conditions.item(title).maxCount < item.GetContent().Count Then
                                config.conditions.item(title).maxCount = item.GetContent().Count
                            End If
                        End If
                    End If
                    
                    title = mc(0).SubMatches(0)
                    If config.conditions.Exists(title) Then
                        itemType = config.conditions.item(title).value_type
                    Else
                        itemType = TYPE_STRING
                        Set cond = New ColumnCondition
                        config.conditions.Add title, cond
                    End If
                    
                    Set item = New StepItem
                    item.Init title, itemType
                    GoTo CONTINUE
                End If
                
                If Not item Is Nothing Then
                    If Len(Trim(line)) > 0 Then
                        item.AddContentLine (RTrim(line))
                    End If
                End If
            End With
            'Cells(rowNumber, 1).Value = line
            'rowNumber = rowNumber + 1]
CONTINUE:
        Loop
```

### åˆ—ãƒ˜ãƒƒãƒ€ãƒ¼ã®å‡¦ç†ã‚’ä¿®æ­£

`ColumnConfig` ã‚¯ãƒ©ã‚¹ã® `AllConditions` é–¢æ•°ã‹ã‚‰ã™ã¹ã¦ã®åˆ—æƒ…å ±ã‚’å–å¾—ã—ã€å‡¦ç†ã™ã‚‹ã€‚

```vba
        ' column header
        Dim key As Variant
        Dim colNumber As Long
        colNumber = 1
        For Each key In config.AllConditions().Keys
            titleRow = rowNumber
            columns(colNumber).ColumnWidth = config.AllConditions().item(key).width
            With Cells(rowNumber, colNumber)
                .Value = key
                .Font.Bold = True
                .HorizontalAlignment = xlCenter
            End With
            colNumber = colNumber + 1
        Next

        maxCol = colNumber - 1
```

å‡¦ç†çµ‚äº†å¾Œã€ç½«ç·šã‚’å¼•ãæ™‚ã®ãŸã‚ã«æœ€çµ‚åˆ—ç•ªå·ã‚’ `maxCol` ã«æ§ãˆã¦ãŠãã€‚

### è¡¨ã®å†…å®¹ã®å‡¦ç†

è¡¨ã®å†…å®¹ã‚‚ `ColumnConfig` ã«å¯¾å¿œã•ã›ã‚‹ã€‚

```vba
        ' table body
        Dim obj As Object
        Dim content As Collection
        For Each stepDict In steps
            colNumber = 1
            For Each key In config.prepend_columns
                If config.prepend_columns.item(key).value_type = TYPE_INCREMENT Then
                    Cells(rowNumber, colNumber).Value = config.prepend_columns.item(key).initial_value
                    config.prepend_columns.item(key).initial_value = config.prepend_columns.item(key).initial_value + 1
                End If
                colNumber = colNumber + 1
            Next
            For Each key In config.conditions.Keys
                Select Case config.conditions.item(key).value_type
                Case TYPE_LIST
                    If stepDict.Exists(key) Then
                        Set content = stepDict.item(key)
                        listIndex = 1
                        If content.Count > 0 Then
                            For listIndex = 1 To content.Count
                                Cells(rowNumber, colNumber + listIndex - 1).Value = content.item(listIndex)
                            Next
                        End If
                    End If
                    colNumber = colNumber + config.conditions.item(key).maxCount
                Case TYPE_STRING
                    If stepDict.Exists(key) Then
                        Set content = stepDict.item(key)
                        Cells(rowNumber, colNumber).Value = JoinCollection(content)
                    End If
                    colNumber = colNumber + 1
                End Select
            Next
            rowNumber = rowNumber + 1
        Next
```

### ç½«ç·šã‚’å¼•ãå‡¦ç†ã®å¤‰æ›´

åˆ—ãƒ˜ãƒƒãƒ€ãƒ¼ã®å‡¦ç†ã§ä¿å­˜ã—ãŸæœ€çµ‚åˆ—ç•ªå·ã‚’åˆ©ç”¨ã—ã¦ç½«ç·šã‚’å¼•ãã‚ˆã†ã«ä¿®æ­£ã€‚

```
        ' format borders
        Dim index As Long
        With Range(Cells(titleRow, 1), Cells(rowNumber - 1, maxCol))
            For index = xlEdgeLeft To xlInsideHorizontal
                With .Borders(index)
                    .LineStyle = xlContinuous
                    .ColorIndex = 0
                    .TintAndShade = 0
                    .Weight = xlThin
                End With
            Next
        End With
```

### mael ã®ã‚µãƒ³ãƒ—ãƒ«ã‚·ãƒŠãƒªã‚ªã‚’è©¦ã—ã¦ã¿ã‚‹

`mael init .` ã§ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ã‚’é¸æŠã—ãŸéš›ã«ä½œæˆã•ã‚Œã‚‹ `Scenario 1.md` ã§è©¦ã—ã¦ã¿ã‚‹ã€‚

![](https://storage.googleapis.com/zenn-user-upload/978c0f490d84-20250629.png)

Summary ã®å†…å®¹ã«ç©ºè¡ŒãŒå‡ºåŠ›ã•ã‚Œã¦ã„ã‚‹ã®ã§[ä¿®æ­£](https://github.com/yasumichi/maelForVBA/commit/c054ff17b8490bb54dcd77ce7446d3f7f5a2fa89)ã—ãŸã€‚

![](https://github.com/yasumichi/maelForVBA/blob/main/images/Scenario1.png?raw=true)

## ã ã„ã¶è¦‹é€šã—ãŒæ‚ªããªã£ã¦ããŸâ€¦

æ¬¡ã¯ã€ã‚·ãƒ¼ãƒˆä½œæˆå‡¦ç†ã‚’åˆ¥ãƒ—ãƒ­ã‚·ãƒ¼ã‚¸ãƒ£ãƒ¼ã«åˆ†é›¢ã™ã‚‹ã“ã¨ã«ã—ã‚ˆã†ã€‚

## ã“ã“ã¾ã§ã®æˆæœ

ãƒãƒ¼ã‚¸ãƒ§ãƒ³ [0.2](https://github.com/yasumichi/maelForVBA/releases/tag/0.2) ã¨ã—ã¦ã€ãƒ—ãƒ¬ãƒªãƒªãƒ¼ã‚¹ã‚’å…¬é–‹ã—ãŸã€‚