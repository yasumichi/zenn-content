---
title: "commitã‚³ãƒ¡ãƒ³ãƒˆã‚„issueã€Wikiã§ã‚‚ä»£æ›¿ãƒ¬ãƒ³ãƒ€ãƒ©ãƒ¼ã‚’ä½¿ãˆã‚‹ã‚ˆã†ã« GitBucket ã‚’ä¿®æ­£ã—ã¦ãƒ—ãƒ«ãƒªã‚¯ã—ãŸä»¶"
emoji: "ğŸ˜"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["Scala", "GitBucket", "Markdown"]
published: true
---
## å‰å›ã®è¨˜äº‹

https://zenn.dev/yasumichi/articles/c3df6dde7f6838

## æ¦‚è¦

[GitBucket](https://gitbucket.github.io/)ã®ãƒ—ãƒ©ã‚°ã‚¤ãƒ³[GitBucket Markdown Enhanced Plugin](https://github.com/yasumichi/gitbucket-markdown-enhanced)ã‚’é–‹ç™ºä¸­ã®ã¨ã“ã‚ã€[Wikiãƒ»Issuesãƒ»ã‚³ãƒ¡ãƒ³ãƒˆã§ã‚‚æ‹¡å¼µMarkdownã‚’æœ‰åŠ¹ã«ã—ãŸã„](https://github.com/yasumichi/gitbucket-markdown-enhanced/issues/1)ã¨ã„ã†è¦æœ›ã‚’å—ã‘ã¾ã—ãŸã€‚

èª¿æŸ»ã—ãŸã¨ã“ã‚ã€GitBucketæœ¬ä½“ã®æ”¹ä¿®ãŒå¿…è¦ãªã“ã¨ãŒåˆ¤æ˜ã—ãŸãŸã‚ã€æ”¹ä¿®ã‚’è¡Œã„ã€ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’è¡Œã£ãŸè¨˜éŒ²ã§ã™ã€‚

## æ‰‹å§‹ã‚ã« Wiki ã§ä»£æ›¿ãƒ¬ãƒ³ãƒ€ãƒ©ãƒ¼ã‚’ä½¿ç”¨ã§ãã‚‹ã‚ˆã†ã«ä¿®æ­£

[src/main/twirl/gitbucket/core/wiki/page.scala.html](https://github.com/gitbucket/gitbucket/blob/fb48c2a8741f856aebb98ecb7646763b291d2f5e/src/main/twirl/gitbucket/core/wiki/page.scala.html)ã‚’ä¿®æ­£ã—ã¾ã—ãŸã€‚

- [Allow alternative renderers for wiki body. Â· yasumichi/gitbucket@133bcb8](https://github.com/yasumichi/gitbucket/commit/133bcb81ae341485eabade4e69c8400bcaf1abef)

```diff
diff --git a/src/main/twirl/gitbucket/core/wiki/page.scala.html b/src/main/twirl/gitbucket/core/wiki/page.scala.html
index 855856ce..05a54085 100644
--- a/src/main/twirl/gitbucket/core/wiki/page.scala.html
+++ b/src/main/twirl/gitbucket/core/wiki/page.scala.html
@@ -82,16 +82,14 @@
     </div>
     <div class="wiki-main">
       <div class="markdown-body">
-        @helpers.markdown(
-          markdown = page.content,
-          repository = repository,
+        @helpers.renderMarkup(
+          filePath = page.name.split("/").toList,
+          fileContent = page.content,
           branch = "master",
+          repository = repository,
           enableWikiLink = true,
           enableRefsLink = false,
-          enableLineBreaks = false,
-          enableTaskList = false,
-          hasWritePermission = false,
-          pages = pages
+          enableAnchor = true
         )
       </div>
       @footer.map { footerPage =>
```

ã“ã‚Œã§ä¸‹ã®ç”»åƒã®ã‚ˆã†ã« Wiki ã§ã‚‚ GitBucket Markdown Enhanced Plugin ãŒä½¿ç”¨ã•ã‚Œã€PlantUML ã«ã‚ˆã‚‹å›³ãŒè¡¨ç¤ºã§ãã¾ã—ãŸã€‚

![](https://storage.googleapis.com/zenn-user-upload/45f7e603b0aa-20251129.png)

ã—ã‹ã—ãªãŒã‚‰ã€ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ã«ã—ã¦ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’è¡Œã†ã¨ã†ã¾ãã„ãã¾ã›ã‚“ã€‚

![](https://storage.googleapis.com/zenn-user-upload/01bef27c170f-20251129.png)

# ç·¨é›†ä¸­ã®ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã§ã‚‚ä»£æ›¿ãƒ¬ãƒ³ãƒ€ãƒ©ãƒ¼ã‚’ä½¿ç”¨ã§ãã‚‹ã‚ˆã†ã«ä¿®æ­£

[src/main/twirl/gitbucket/core/helper/preview.scala.html](https://github.com/gitbucket/gitbucket/blob/fb48c2a8741f856aebb98ecb7646763b291d2f5e/src/main/twirl/gitbucket/core/helper/preview.scala.html)ã‚’ä¿®æ­£ã—ã¾ã—ãŸã€‚

- [Allow alternative renderers for issue Â· yasumichi/gitbucket@c8eaec6](https://github.com/yasumichi/gitbucket/commit/c8eaec67843d00aefba086570e4f123a60cc7347#diff-09a9e72c7c762d304a462277b76360fa74dd2dc746504a2e15a1ce742a81aede)

```diff
diff --git a/src/main/twirl/gitbucket/core/helper/preview.scala.html b/src/main/twirl/gitbucket/core/helper/preview.scala.html
index 1276c68e..6a2cb0fc 100644
--- a/src/main/twirl/gitbucket/core/helper/preview.scala.html
+++ b/src/main/twirl/gitbucket/core/helper/preview.scala.html
@@ -57,6 +57,7 @@ $(function(){
   $('#preview@uid').click(function(){
     $('#preview-area@uid').html('<img src="@helpers.assets("/common/images/indicator.gif")"> Previewing...');
     $.post('@helpers.url(repository)/_preview', {
+      filename         : "temporary.md",
       content          : $('#content@uid').val(),
       enableWikiLink   : @enableWikiLink,
       enableRefsLink   : @enableRefsLink,
```

ã“ã‚Œã§ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã«ã‚‚GitBucket Markdown Enhanced Plugin ãŒä½¿ç”¨ã•ã‚Œã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã—ãŸã€‚

![](https://storage.googleapis.com/zenn-user-upload/0d6bc62338a4-20251129.png)

## Issue ã§ã‚‚ä»£æ›¿ãƒ¬ãƒ³ãƒ€ãƒ©ãƒ¼ã‚’ä½¿ç”¨ã§ãã‚‹ã‚ˆã†ã«ä¿®æ­£

[src/main/twirl/gitbucket/core/issues/commentlist.scala.html](https://github.com/gitbucket/gitbucket/blob/fb48c2a8741f856aebb98ecb7646763b291d2f5e/src/main/twirl/gitbucket/core/issues/commentlist.scala.html)

```diff
diff --git a/src/main/twirl/gitbucket/core/issues/commentlist.scala.html b/src/main/twirl/gitbucket/core/issues/commentlist.scala.html
index a0240e9f..a99cf3bf 100644
--- a/src/main/twirl/gitbucket/core/issues/commentlist.scala.html
+++ b/src/main/twirl/gitbucket/core/issues/commentlist.scala.html
@@ -32,15 +32,14 @@
     }
   </div>
   <div class="panel-body markdown-body" id="commentContent-@comment.commentId">
-    @helpers.markdown(
-      markdown           = comment.content,
-      repository         = repository,
+    @helpers.renderMarkup(
+      filePath           = List("temporary.md"),
+      fileContent        = comment.content,
       branch             = repository.repository.defaultBranch,
+      repository         = repository,
       enableWikiLink     = false,
       enableRefsLink     = true,
-      enableLineBreaks   = true,
-      enableTaskList     = true,
-      hasWritePermission = isManageable
+      enableAnchor       = true
     )
   </div>
 </div>
@@ -58,15 +57,14 @@
       </span>
     </div>
     <div class="panel-body markdown-body" id="issueContent">
-      @helpers.markdown(
-        markdown           = issue.get.content getOrElse "No description provided.",
-        repository         = repository,
+      @helpers.renderMarkup(
+        filePath           = List("temporary.md"),
+        fileContent        = issue.get.content getOrElse "No description provided.",
         branch             = repository.repository.defaultBranch,
+        repository         = repository,
         enableWikiLink     = false,
         enableRefsLink     = true,
-        enableLineBreaks   = true,
-        enableTaskList     = true,
-        hasWritePermission = isManageable
+        enableAnchor       = true
       )
     </div>
   </div>
@@ -331,15 +329,14 @@
         }
       </div>
       <div class="panel-body markdown-body commit-commentContent-@comment.commentId">
-        @helpers.markdown(
-          markdown           = comment.content,
-          repository         = repository,
+        @helpers.renderMarkup(
+          filePath           = List("temporary.md"),
+          fileContent        = comment.content,
           branch             = repository.repository.defaultBranch,
+          repository         = repository,
           enableWikiLink     = false,
           enableRefsLink     = true,
-          enableLineBreaks   = true,
-          enableTaskList     = true,
-          hasWritePermission = isManageable
+          enableAnchor       = true
         )
       </div>
     </div>
```

ã“ã‚Œã§ issue ã«ã‚‚ GitBucket Markdown Enhanced Plugin ãŒä½¿ç”¨ã•ã‚Œã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã—ãŸã€‚

![](https://storage.googleapis.com/zenn-user-upload/7b7e4263a057-20251129.png)

ã—ã‹ã—ã€ã‚³ãƒ¡ãƒ³ãƒˆã‚’ç·¨é›†ã—æ›´æ–°ã™ã‚‹ã¨ã†ã¾ãã„ãã¾ã›ã‚“ã€‚

![](https://storage.googleapis.com/zenn-user-upload/30cd7721d9ce-20251129.png)

æ”¹å–„ã™ã‚‹ã«ã¯ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼ã®æ”¹ä¿®ãŒå¿…è¦ã§ã—ãŸã€‚

## IssuesController ã®ä¿®æ­£

[src/main/scala/gitbucket/core/controller/IssuesController.scala](https://github.com/gitbucket/gitbucket/blob/fb48c2a8741f856aebb98ecb7646763b291d2f5e/src/main/scala/gitbucket/core/controller/IssuesController.scala)ã‚’ä¿®æ­£ã—ã¾ã—ãŸã€‚

- [Allow alternative renderers for issue post Â· yasumichi/gitbucket@41d1cb4](https://github.com/yasumichi/gitbucket/commit/41d1cb49560c59b8157ceb60a6360fe09c6b0b96)

```diff
diff --git a/src/main/scala/gitbucket/core/controller/IssuesController.scala b/src/main/scala/gitbucket/core/controller/IssuesController.scala
index a4b04180..676a7684 100644
--- a/src/main/scala/gitbucket/core/controller/IssuesController.scala
+++ b/src/main/scala/gitbucket/core/controller/IssuesController.scala
@@ -8,6 +8,7 @@ import gitbucket.core.util.Implicits.*
 import gitbucket.core.util.*
 import gitbucket.core.view
 import gitbucket.core.view.Markdown
+import gitbucket.core.view.helpers
 import org.scalatra.forms.*
 import org.scalatra.{BadRequest, Ok}

@@ -274,17 +275,15 @@ trait IssuesControllerBase extends ControllerBase {
             org.json4s.jackson.Serialization.write(
               Map(
                 "title" -> x.title,
-                "content" -> Markdown.toHtml(
-                  markdown = x.content getOrElse "No description given.",
-                  repository = repository,
+                "content" -> helpers.renderMarkup(
+                  filePath = List("temporary.md"),
+                  fileContent = x.content getOrElse "No description given.",
                   branch = repository.repository.defaultBranch,
+                  repository = repository,
                   enableWikiLink = false,
                   enableRefsLink = true,
-                  enableAnchor = true,
-                  enableLineBreaks = true,
-                  enableTaskList = true,
-                  hasWritePermission = true
-                )
+                  enableAnchor = true
+                ).toString()
               )
             )
           }
@@ -303,17 +302,15 @@ trait IssuesControllerBase extends ControllerBase {
             contentType = formats("json")
             org.json4s.jackson.Serialization.write(
               Map(
-                "content" -> view.Markdown.toHtml(
-                  markdown = x.content,
-                  repository = repository,
+                "content" -> helpers.renderMarkup(
+                  filePath = List("temporary.md"),
+                  fileContent = x.content,
                   branch = repository.repository.defaultBranch,
+                  repository = repository,
                   enableWikiLink = false,
                   enableRefsLink = true,
-                  enableAnchor = true,
-                  enableLineBreaks = true,
-                  enableTaskList = true,
-                  hasWritePermission = true
-                )
+                  enableAnchor = true
+                ).toString()
               )
             )
           }
```

ã“ã‚Œã§å‰é …ã®å•é¡ŒãŒè§£æ¶ˆã—ã¾ã—ãŸã€‚

ãªãŠã€helpers.renderMarkup() ã®çµæœã‚’ toString() ãƒ¡ã‚½ãƒƒãƒ‰ã§æ–‡å­—åˆ—ã«å¤‰æ›ã—ã¦ã‹ã‚‰ json4s ã«æ¸¡ã•ãªã„ã¨ java.lang.StackOverflowError ãŒç™ºç”Ÿã—ã€Internal Server Error ã¨ãªã£ã¦ã—ã¾ã„ã¾ã—ãŸã€‚

## commitã‚³ãƒ¡ãƒ³ãƒˆã§ã‚‚ä»£æ›¿ãƒ¬ãƒ³ãƒ€ãƒ©ãƒ¼ã‚’ä½¿ç”¨ã§ãã‚‹ã‚ˆã†ã«ä¿®æ­£

é †ç•ªãŒå‰å¾Œã—ã¦ã„ã¾ã™ãŒâ€¦

[src/main/twirl/gitbucket/core/helper/commitcomment.scala.html](https://github.com/gitbucket/gitbucket/blob/fb48c2a8741f856aebb98ecb7646763b291d2f5e/src/main/twirl/gitbucket/core/helper/commitcomment.scala.html)ã‚’ä¿®æ­£ã—ã¾ã—ãŸã€‚

```diff
diff --git a/src/main/twirl/gitbucket/core/helper/commitcomment.scala.html b/src/main/twirl/gitbucket/core/helper/commitcomment.scala.html
index c0542ee6..0d097c95 100644
--- a/src/main/twirl/gitbucket/core/helper/commitcomment.scala.html
+++ b/src/main/twirl/gitbucket/core/helper/commitcomment.scala.html
@@ -21,15 +21,14 @@
         </span>
       </div>
       <div class="commit-commentContent-@comment.commentId">
-        @helpers.markdown(
-          markdown           = comment.content,
-          repository         = repository,
+        @helpers.renderMarkup(
+          filePath           = List("temporary.md"),
+          fileContent        = comment.content,
           branch             = repository.repository.defaultBranch,
+          repository         = repository,
           enableWikiLink     = false,
           enableRefsLink     = true,
-          enableLineBreaks   = true,
-          enableTaskList     = true,
-          hasWritePermission = hasWritePermission
+          enableAnchor       = true
         )
       </div>
     </div>
```

ã“ã‚Œã§ã‚³ãƒŸãƒƒãƒˆã‚³ãƒ¡ãƒ³ãƒˆã§ã‚‚ GitBucket Markdown Enhanced Plugin ãŒä½¿ç”¨ã•ã‚Œã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã—ãŸã€‚

![](https://storage.googleapis.com/zenn-user-upload/4aa67f5d29b7-20251129.png)

## ã“ã“ã¾ã§ã®ä¿®æ­£ã§ã¯æ—¢å­˜ã®æ©Ÿèƒ½ã‚’å£Šã—ã¦ã—ã¾ã†ã“ã¨ãŒåˆ¤æ˜

helpers.markdown() ã®å‘¼ã³å‡ºã—ã«ä½¿ç”¨ã—ã¦ã„ãŸ hasWritePermission ã«ã‚ãŸã‚‹ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãƒ¼ãŒã€helpers.renderMarkup() ã«ã¯ãªã„ã“ã¨ãŒæ°—ã«ãªã£ã¦ã„ãŸã®ã§èª¿æŸ»ã—ãŸã¨ã“ã‚ã€æ—¢å­˜ã®æ©Ÿèƒ½ã§ã¯ã€ã‚¿ã‚¹ã‚¯ãƒªã‚¹ãƒˆã®ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ãŒã€ç·¨é›†æ¨©é™ãŒã‚ã‚‹ã¨åˆ‡ã‚Šæ›¿ãˆå¯èƒ½ã ã£ãŸã®ã§ã™ãŒã€ã“ã“ã¾ã§ã®ä¿®æ­£ã§ã¯ãã®æ©Ÿèƒ½ã‚’æ®ºã—ã¦ã—ã¾ã„ã¾ã—ãŸã€‚

æœ€çµ‚çš„ã«ã‚³ãƒŸãƒƒãƒˆã‚’æ•´ç†ã—ã€ä¿®æ­£ã—ãªãŠã—ãŸã®ãŒä»¥ä¸‹ã®ã‚³ãƒŸãƒƒãƒˆã§ã™ã€‚

- [Added support for an alternative renderer to commit comments, wikis, â€¦ Â· yasumichi/gitbucket@c23e444](https://github.com/yasumichi/gitbucket/commit/c23e444789eab86065fbf127581e9a390ebd7409)

å·®åˆ†ã¯é•·ããªã‚‹ã®ã§å‰²æ„›ã—ã¾ã™ãŒã€ç·¨é›†æ¨©é™ãŒã‚ã‚‹å ´åˆã¯ã€`<input type="checkbox">` ã® disabled å±æ€§ã‚’å‰Šé™¤ã™ã‚‹ã‚ˆã†ã«ä¿®æ­£ã—ã¾ã—ãŸã€‚

```scala
            val re = "disabled[^<>]*>".r
            var content = helpers.renderMarkup(
                  filePath = List("temporary.md"),
                  fileContent = x.content getOrElse "No description given.",
                  branch = repository.repository.defaultBranch,
                  repository = repository,
                  enableWikiLink = false,
                  enableRefsLink = true,
                  enableAnchor = true
            ).toString()
            content = re.replaceAllIn(content, ">")
```

æœ¬å®¶ã® MarkdownRenderer ã¨ GitBucket Markdown Enhanced Plugin ã§ã¯ã€å¾®å¦™ã«ç”Ÿæˆã™ã‚‹ HTML ãŒç•°ãªã‚‹ã®ã§æ­£è¦è¡¨ç¾ãŒå¾®å¦™ã§ã™ã‘ã©â€¦

ã“ã®ã‚³ãƒŸãƒƒãƒˆã§æœ€çµ‚çš„ãªãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’ç™ºè¡Œã—ã¾ã—ãŸã€‚

- [Added support for an alternative renderer to commit comments, wikis, and issues. by yasumichi Â· Pull Request #3881 Â· gitbucket/gitbucket](https://github.com/gitbucket/gitbucket/pull/3881)

æ¡ç”¨ã—ã¦ã‚‚ã‚‰ãˆã‚‹ã¨è‰¯ã„ã®ã§ã™ãŒâ€¦

## å¾Œæ—¥è«‡ï¼ˆè¿½è¨˜ï¼‰

### Copilot ã‹ã‚‰ã®æŒ‡æ‘˜

- if~elseã®åˆ†å²ã§é‡è¤‡ã‚³ãƒ¼ãƒ‰ãŒå­˜åœ¨
- twirl ã§éæ¨å¥¨ã®ã‚³ãƒ¼ãƒ‰ãƒ–ãƒ­ãƒƒã‚¯ `@{ var commentContent = ... } ` ãŒå­˜åœ¨
  - å‡¦ç†ã®å…±é€šåŒ–ã‚’ç¤ºå”†(ãŸã‘ãã†ã•ã‚“è¦‹è§£)

### æ•´å½¢ã®å¿…è¦æ€§

ãŸã‘ãã†ã•ã‚“ã‹ã‚‰ã€CI ã§æ›¸å¼ã«é–¢ã™ã‚‹ã‚¨ãƒ©ãƒ¼ãŒå‡ºã¦ã„ã‚‹ã®ã§ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã™ã‚‹ã‚ˆã†ã«ã¨ã‚³ãƒ¡ãƒ³ãƒˆã‚’å—ã‘ã¾ã—ãŸã€‚

```
sbt scalafmtAll
```
### æ–°ãŸãªãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆ

- [Add support for an alternative renderer to commit comments, wikis, and issues. by yasumichi Â· Pull Request #3882 Â· gitbucket/gitbucket](https://github.com/gitbucket/gitbucket/pull/3882)

#### è¿½åŠ äº‹é …

- ç·¨é›†æ¨©é™ãŒã‚ã‚‹å ´åˆã«ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã‚’æœ‰åŠ¹åŒ–ã™ã‚‹å‡¦ç†ã‚’å…±é€šåŒ–([helpers.enableCheckbox()](https://github.com/gitbucket/gitbucket/pull/3882/commits/c17d5023092b6a6256d31d35745139e0682da641)ã‚’å®šç¾©)
  - æ­£è¦è¡¨ç¾ã‚‚è¦‹ç›´ã—
  - çµæœã¨ã—ã¦åˆ†å²ãŒæ¸›å°‘

```scala
  /**
    * Utility method to enable checkboxes
    */
  def enableCheckbox(html: Html, enable: Boolean): Html = {
    if (enable) {
      val re = "(<input\\s+[^<>]*type=\"checkbox\"\\s+[^<>]*)\\s+disabled[^<>]*>".r
      Html(re.replaceAllIn(html.toString(), "$1>"))
    } else {
      html
    }
  }
```

- [ã‚³ãƒŸãƒƒãƒˆã‚³ãƒ¡ãƒ³ãƒˆã‚’ç·¨é›†ç¢ºå®šæ™‚ã«ä»£æ›¿ãƒ¬ãƒ³ãƒ€ãƒ©ãƒ¼ãŒä½¿ã‚ã‚Œãªã„ãƒã‚°ã‚’ä¿®æ­£](https://github.com/gitbucket/gitbucket/pull/3882/commits/6eec7a09a183fcc5d8efa237a2182495bd4c1f8d)(RepositoryViewerController ã®ä¿®æ­£ã‚’è¿½åŠ )
- [Wikiã®æœ¬æ–‡ã®ã¿ã®å‡¦ç†ã§ã‚ã£ãŸã®ã‚’ã‚«ã‚¹ã‚¿ãƒ ã‚µã‚¤ãƒ‰ãƒãƒ¼ã‚„ãƒ•ãƒƒã‚¿ãƒ¼ã«ã‚‚æ‹¡å¤§](https://github.com/gitbucket/gitbucket/pull/3882/commits/32666cbcd8d7f85b8c63effd7a3941ede551f1d9)