---
title: "gitbucket-drawio-plugin ã‹ã‚‰ã‚»ãƒ«ãƒ•ãƒ›ã‚¹ãƒˆã® draw.io ã«ã‚¢ã‚¯ã‚»ã‚¹ã•ã›ãŸã„"
emoji: "ğŸ¦”"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["GitBucket", "Scala", "JavaScript", "drawio"]
published: true
---

## å‰å›ã®è¨˜äº‹

https://zenn.dev/yasumichi/articles/04d09995388959

## ã‚¯ãƒ­ãƒ¼ã‚ºãƒ‰ç’°å¢ƒã§ä½¿ç”¨ã—ãŸã‚‰ draw.io æœ¬å®¶ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã‚ˆã†ã¨ã—ã¦ã„ãŸ

ã‚ã‚‹ç¨‹åº¦ã€äºˆæƒ³ã¯ã¤ã„ã¦ã„ãŸã®ã ãŒã€`viewer.min.js` ã‹ã‚‰ã€[draw.io æœ¬å®¶](https://viewer.diagrams.net/)ã®è¤‡æ•°ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆã¸ã‚¢ã‚¯ã‚»ã‚¹ã—ã‚ˆã†ã¨ã™ã‚‹ãŸã‚ã€ã‚¯ãƒ­ãƒ¼ã‚ºãƒ‰ç’°å¢ƒã§ã¯ã€ä¸€æ™‚çš„ã«ãƒ–ãƒ­ãƒƒã‚­ãƒ³ã‚°ãŒç™ºç”Ÿã™ã‚‹ã€‚å®Ÿéš›ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã‚ˆã†ã¨ã—ã¦ã„ãŸ URL ã¯ä»¥ä¸‹ã®é€šã‚Šã€‚

- https://app.diagrams.net/math/es5/startup.js
- https://app.diagrams.net/math/es5/core.js
- https://app.diagrams.net/math/es5/output/svg.js
- https://app.diagrams.net/math/es5/input/tex.js
- https://app.diagrams.net/math/es5/input/asciimath.js
- https://app.diagrams.net/math/es5/ui/safe.js
- https://app.diagrams.net/math/es5/output/svg/fonts/tex.js

## ä¿®æ­£ã®å‚è€ƒã«ã—ãŸãƒ—ãƒ©ã‚°ã‚¤ãƒ³

[gitbucket-commitgraphs-plugin](https://github.com/yoshiyoshifujii/gitbucket-commitgraphs-plugin)

## è¨­å®šã‚’ä¿å­˜ã§ãã‚‹ã‚µãƒ¼ãƒ“ã‚¹ã®ä½œæˆ

[gitbucket-commitgraphs-plugin/src/main/scala/me/huzi/gitbucket/commitgraphs/service/CommitGraphsSettingsService.scala](https://github.com/yoshiyoshifujii/gitbucket-commitgraphs-plugin/blob/7427e3ffb2debf30f49eb72c79547e93e6dc7887/src/main/scala/me/huzi/gitbucket/commitgraphs/service/CommitGraphsSettingsService.scala)ã‚’å‚è€ƒã«[gitbucket-drawio-plugin/src/main/scala/DrawioSettingsService.scala](https://github.com/yasumichi/gitbucket-drawio-plugin/blob/52f67d2b87917b4e20c4e2ed2b91d41f7478409e/src/main/scala/DrawioSettingsService.scala)ã‚’ä½œæˆã€‚

```scala
import java.io.File
import scala.util.Using
import gitbucket.core.util.Directory._
import gitbucket.core.util.SyntaxSugars._
import DrawioSettingsService._

trait DrawioSettingsService {

  val DrawioConf = new File(GitBucketHome, "drawio.conf")

  def  saveDrawioSettings(settings: DrawioSettings): Unit =
    defining(new java.util.Properties()) { props =>
      props.setProperty(DrawioBaseUrl, settings.DrawioBaseUrl)
      Using.resource(new java.io.FileOutputStream(DrawioConf)) { out =>
        props.store(out, null)
      }
    }

  def loadDrawioSettings(): DrawioSettings =
    defining(new java.util.Properties()) { props =>
      if (DrawioConf.exists) {
        Using.resource(new java.io.FileInputStream(DrawioConf)) { in =>
          props.load(in)
        }
      }
      DrawioSettings(
        getValue[String](props, DrawioBaseUrl, "")  
      )
    }
}

object DrawioSettingsService {
  import scala.reflect.ClassTag    
  
  case class DrawioSettings(DrawioBaseUrl: String)

  private val DrawioBaseUrl = "DrawioBaseUrl"

  private def getValue[A: ClassTag](props: java.util.Properties,
                                    key: String,
                                    default: A): A =
    defining(props.getProperty(key)) { value =>
      if (value == null || value.isEmpty) default
      else convertType(value).asInstanceOf[A]
    }

  private def getOptionValue[A: ClassTag](props: java.util.Properties,
                                          key: String,
                                          default: Option[A]): Option[A] =
    defining(props.getProperty(key)) { value =>
      if (value == null || value.isEmpty) default
      else Some(convertType(value)).asInstanceOf[Option[A]]
    }

  private def convertType[A: ClassTag](value: String) =
    defining(implicitly[ClassTag[A]].runtimeClass) { c =>
      if (c == classOf[Boolean]) value.toBoolean
      else if (c == classOf[Int]) value.toInt
      else value
    }
}
```

GitBucket ã®ãƒ›ãƒ¼ãƒ ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã« `drawio.conf` ã¨ã„ã†ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ã€ä»¥ä¸‹ã®ã‚ˆã†ã« `DrawioBaseUrl` ã¨ã„ã†è¨­å®šå€¤ã‚’ä¿å­˜ã™ã‚‹ã€‚

```
#Sat Jul 26 21:09:46 JST 2025
DrawioBaseUrl=http\://localhost\:8080/draw/
```

[trait](https://docs.scala-lang.org/ja/tour/traits.html) ã¯ Java ã® interface ã«ä¼¼ã¦ã‚‹ã‚‰ã—ã„ã€‚åŒã˜åå‰ã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãŒå®šç¾©ã•ã‚Œã¦ã„ã‚‹ã®ã¯ã€[ã‚³ãƒ³ãƒ‘ãƒ‹ã‚ªãƒ³ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ](https://docs.scala-lang.org/ja/tour/singleton-objects.html#%E3%82%B3%E3%83%B3%E3%83%91%E3%83%8B%E3%82%AA%E3%83%B3%E3%82%AA%E3%83%96%E3%82%B8%E3%82%A7%E3%82%AF%E3%83%88)ã«å½“ãŸã‚‹ã¨æ€ã‚ã‚Œã‚‹ã€‚

## è¨­å®šç”»é¢ç”¨ã® twirl ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã®ä½œæˆ

![](https://storage.googleapis.com/zenn-user-upload/c8d000b77e3f-20250726.png)

ä¸Šå›³ã®ã‚ˆã†ãªè¨­å®šç”»é¢ã‚’è¡¨ç¤ºã™ã‚‹ãŸã‚ã® [twirl](https://github.com/playframework/twirl) ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’ä½œæˆã™ã‚‹ã€‚

twirl ã‚’ä½¿ç”¨ã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹ãŸã‚ã€[gitbucket-drawio-plugin/project/plugins.sbt](https://github.com/yasumichi/gitbucket-drawio-plugin/blob/52f67d2b87917b4e20c4e2ed2b91d41f7478409e/project/plugins.sbt)ã«ä»¥ä¸‹ã®è¡Œã‚’è¿½åŠ ã™ã‚‹ã€‚

```scala
addSbtPlugin("org.playframework.twirl" % "sbt-twirl" % "2.0.9")
```

`LATEST` ã ã¨ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã‚’å–å¾—ã§ããªã‹ã£ãŸã®ã§å°‘ã—å¤ã„ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’æŒ‡å®šã—ãŸã€‚

ã¾ãŸã€[gitbucket-drawio-plugin/build.sbt](https://github.com/yasumichi/gitbucket-drawio-plugin/blob/52f67d2b87917b4e20c4e2ed2b91d41f7478409e/build.sbt)ã«ä»¥ä¸‹ã®è¡Œã‚’æŒ¿å…¥ã—ãŸã€‚

```scala
lazy val root = (project in file(".")).enablePlugins(SbtTwirl)
```

ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã¨ã—ã¦ã€[gitbucket-commitgraphs-plugin/src/main/twirl/me/huzi/gitbucket/commitgraphs/settings.scala.html](https://github.com/yoshiyoshifujii/gitbucket-commitgraphs-plugin/blob/7427e3ffb2debf30f49eb72c79547e93e6dc7887/src/main/twirl/me/huzi/gitbucket/commitgraphs/settings.scala.html)ã‚’å‚è€ƒã«[gitbucket-drawio-plugin/src/main/twirl/settings.scala.htm](https://github.com/yasumichi/gitbucket-drawio-plugin/blob/52f67d2b87917b4e20c4e2ed2b91d41f7478409e/src/main/twirl/settings.scala.html)ã‚’ä½œæˆã—ãŸã€‚

```scala
@(DrawioBaseUrl: String, info: Option[Any])(implicit context: gitbucket.core.controller.Context)
@import context._
@import gitbucket.core.html.main
@import gitbucket.core.admin.html.menu
@import gitbucket.core.helper.html.information
@import gitbucket.core.view.helpers._
@import gitbucket.core.util.Directory._
@main("draw.io"){
@menu("draw.io"){
@information(info)
<form action="@path/admin/drawio" method="POST" validate="true">
    <div class="panel panel-default">
        <div class="panel-heading strong">draw.io Settings</div>
        <div class="panel-body">
            <fieldset>
                <label><span class="strong">draw.io base url</span></label>
                <input type="text" style="width: 635px;" name="DrawioBaseUrl" value="@DrawioBaseUrl"/>
                <p class="muted">e.g. https://app.diagrams.net/</p>
            </fieldset>
        </div>
    </div>
    <fieldset>
        <input type="submit" class="btn btn-success" value="Apply changes"/>
    </fieldset>
</form>
}
}
```

å†’é ­ã®  `@(DrawioBaseUrl: String, info: Option[Any])` ã§å¤–éƒ¨ã‹ã‚‰ã€`DrawioBaseUrl` ã¨å¿…è¦ã«ã‚ˆã‚Šã€æƒ…å ±ã‚’ä¸ãˆã‚‰ã‚Œã‚‹ã‚ˆã†ã«ã—ã¦ã„ã‚‹ã€‚

ä½œæˆã—ãŸ `settings.scala.htm` ã«ã¯ã€Scala ã‚½ãƒ¼ã‚¹ã‹ã‚‰ã€`html.settings` ã§ã‚¢ã‚¯ã‚»ã‚¹ã§ãã‚‹ã‚ˆã†ã§ã‚ã‚‹ã€‚

## è¨­å®šç”»é¢ã‚’è¡¨ç¤ºã™ã‚‹ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼ã®ä½œæˆ

[gitbucket-commitgraphs-plugin/src/main/scala/me/huzi/gitbucket/commitgraphs/controller/CommitGraphsController.scala](https://github.com/yoshiyoshifujii/gitbucket-commitgraphs-plugin/blob/7427e3ffb2debf30f49eb72c79547e93e6dc7887/src/main/scala/me/huzi/gitbucket/commitgraphs/controller/CommitGraphsController.scala)ã‚’å‚è€ƒã«[gitbucket-drawio-plugin/src/main/scala/DrawioController.scala](https://github.com/yasumichi/gitbucket-drawio-plugin/blob/52f67d2b87917b4e20c4e2ed2b91d41f7478409e/src/main/scala/DrawioController.scala)ã‚’ä½œæˆã—ãŸã€‚

```scala
import scala.jdk.CollectionConverters._
import scala.sys.process._
import scala.util.Using
import org.eclipse.jgit.api.Git
import gitbucket.core.controller._
import gitbucket.core.service._
import gitbucket.core.util._
import gitbucket.core.util.AdminAuthenticator
import gitbucket.core.util.SyntaxSugars._
import gitbucket.core.util.Directory._
import gitbucket.core.util.JGitUtil._
import org.scalatra.forms._
import DrawioSettingsService._

class DrawioController extends DrawioControllerBase
  with RepositoryService with AccountService
  with ReferrerAuthenticator with AdminAuthenticator
  with DrawioSettingsService

trait DrawioControllerBase extends ControllerBase {
  self: RepositoryService with AccountService with ReferrerAuthenticator with AdminAuthenticator with DrawioSettingsService =>

  val settingsForm: MappingValueType[DrawioSettings] = mapping(
    "DrawioBaseUrl"   -> text(required, maxlength(200))
  )(DrawioSettings.apply)

  get("/admin/drawio")(adminOnly {
    val settings = loadDrawioSettings()
    html.settings(settings.DrawioBaseUrl, None)
  }
  )

  post("/admin/drawio", settingsForm)(adminOnly { form =>
    assert(form.DrawioBaseUrl != null)
    saveDrawioSettings(form)
    html.settings(form.DrawioBaseUrl, Some("Settings Saved"))
  })
}
```

`get("/admin/drawio")` ã§è¨­å®šç”»é¢ã‚’è¡¨ç¤ºã™ã‚‹å‡¦ç†ã€`post("/admin/drawio", settingsForm)`ã§`Apply changes`ãŒæŠ¼ã•ã‚ŒãŸéš›ã®å‡¦ç†ã‚’å®šç¾©ã—ã¦ã„ã‚‹ã€‚

## System administration ã®ã‚µã‚¤ãƒ‰ãƒãƒ¼ã«è¨­å®šç”»é¢ã¸ã®ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’è¿½åŠ 

[gitbucket-commitgraphs-plugin/src/main/scala/Plugin.scala](https://github.com/yoshiyoshifujii/gitbucket-commitgraphs-plugin/blob/7427e3ffb2debf30f49eb72c79547e93e6dc7887/src/main/scala/Plugin.scala)ã‚’å‚è€ƒã«[gitbucket-drawio-plugin/src/main/scala/Plugin.scala](https://github.com/yasumichi/gitbucket-drawio-plugin/blob/52f67d2b87917b4e20c4e2ed2b91d41f7478409e/src/main/scala/Plugin.scala)ã‚’ä¿®æ­£ã™ã‚‹ã€‚

ã¾ãšã€`gitbucket.core.plugin.Plugin` ã‹ã‚‰æ´¾ç”Ÿã•ã›ãŸ `Plugin` ã‚¯ãƒ©ã‚¹ã§  `controllers` ã‚’ override ã—å‰é …ã§ä½œæˆã—ãŸã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼ã‚’è¿½åŠ ã™ã‚‹ã€‚

```scala
  override val controllers = Seq(
    "/*" -> new DrawioController
  )
```

ãã—ã¦ã€ã‚µã‚¤ãƒ‰ãƒãƒ¼ã«ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’è¿½åŠ ã™ã‚‹ãŸã‚ã€  `systemSettingMenus` ã‚’ override ã™ã‚‹ã€‚

```scala
  override val systemSettingMenus: Seq[(Context) => Option[Link]] = Seq(
    (ctx: Context) => Some(Link("draw.io","draw.io","admin/drawio"))
  )
```

ã“ã‚Œã§ä¸‹å›³ã®ã‚ˆã†ã« `draw.io` ã¨ã„ã†ãƒ¡ãƒ‹ãƒ¥ãƒ¼ãŒè¿½åŠ ã•ã‚Œã‚‹ã€‚

![](https://storage.googleapis.com/zenn-user-upload/8aaa8e376827-20250726.png)

## renderer ã®ä¿®æ­£

[gitbucket-drawio-plugin/src/main/scala/DrawioRenderer.scala](https://github.com/yasumichi/gitbucket-drawio-plugin/blob/52f67d2b87917b4e20c4e2ed2b91d41f7478409e/src/main/scala/DrawioRenderer.scala) ã§è¨­å®šã«å¿œã˜ãŸãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ãŒã§ãã‚‹ã‚ˆã†ã«ä¿®æ­£ã—ãŸã€‚

```scala
  def toHtml(content: String)(implicit context: Context): String = {
    val path = context.baseUrl
    val settings = loadDrawioSettings()
    var viewer = "";
    var baseUrl = "https://viewer.diagrams.net/"
    if (settings.DrawioBaseUrl != "") {
      viewer = settings.DrawioBaseUrl + "/js/viewer.min.js"
      baseUrl = settings.DrawioBaseUrl
    } else {
      viewer = path + "/plugin-assets/drawio/viewer.min.js"
    }
    val data = content.replaceAll("&", "&amp;")
                      .replaceAll("'", "&#x27;")
                      .replaceAll("`", "&#x60;")
                      .replaceAll("\"", "&quot;")
                      .replaceAll("<", "&lt;")
                      .replaceAll(">", "&gt;")

    s"""
       |<link rel="stylesheet" type="text/css" href="$path/plugin-assets/drawio/drawio-renderer.css">
       |<script>
       |window.DRAWIO_BASE_URL = '$baseUrl';
       |window.DRAW_MATH_URL = '$baseUrl' + 'math/es5';
       |</script>
       |<script src="$viewer"></script>
       |<script src="$path/plugin-assets/drawio/drawio-renderer.js"></script>
       |<div class="mxgraph" data-diagram-data="$data"></div>
       |""".stripMargin

  }
```

`DrawioBaseUrl` ã®è¨­å®šã«å¿œã˜ã¦ã€`viewer.min.js` ã®ãƒ‘ã‚¹ã‚„ `window.DRAWIO_BASE_URL` ã¨ `window.DRAW_MATH_URL` ãŒå¤‰æ›´ã•ã‚Œã‚‹ã‚ˆã†ã«ä¿®æ­£ã—ãŸã€‚

ä»Šã®ã¨ã“ã‚ã€`window.DRAWIO_LIGHTBOX_URL` ã¯å¤‰æ›´ã—ã¦ã„ãªã„ã€‚

## ä»Šå›ã®æˆæœç‰©

[Release Added support for connecting to self-hosted draw.io Â· yasumichi/gitbucket-drawio-plugin](https://github.com/yasumichi/gitbucket-drawio-plugin/releases/tag/0.2.0) ã«ãƒ“ãƒ«ãƒ‰æ¸ˆã¿ã®ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã‚’æ·»ä»˜ã—ãŸã€‚(https://github.com/yasumichi/gitbucket-drawio-plugin/releases/download/0.2.0/gitbucket-drawio-plugin-0.2.0.jar)

## æœ¬å®¶ã¸ã® Pull Request

[Added support for connecting to self-hosted draw.io by yasumichi Â· Pull Request #1 Â· onukura/gitbucket-drawio-plugin](https://github.com/onukura/gitbucket-drawio-plugin/pull/1)ã§æœ¬å®¶ã¸ Pull Request ã‚’é€ã£ãŸã€‚

## ä»Šå¾Œã®å¸Œæœ›

- `DrawioBaseUrl` ã®ãƒã‚§ãƒƒã‚¯ãŒç”˜ã„ã®ã§ä¿®æ­£ã™ã‚‹ã€‚
  - URL ã¨ã—ã¦å¦¥å½“ã‹?
  - æœ€å¾Œã« `/` ãŒãªã„å ´åˆã€è£œå®Œã™ã‚‹ã‚ˆã†ã«ã™ã‚‹ã€‚
- å¯èƒ½ã§ã‚ã‚Œã°
  - [åŸ‹ã‚è¾¼ã¿ã‚¨ãƒ‡ã‚£ã‚¿](https://www.drawio.com/doc/faq/embed-mode)ã§ç·¨é›†ã§ãã‚‹ã‚ˆã†ã«ã—ãŸã„ã€‚
  - markdown ã«åŸ‹ã‚è¾¼ã¾ã‚ŒãŸ drawio ã‚’è¡¨ç¤ºã—ãŸã„ã€‚