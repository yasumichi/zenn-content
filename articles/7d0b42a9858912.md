---
title: "GitBucket  Markdown Enhanced Plugin ã« Mark ã®ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°æ©Ÿèƒ½ã‚’è¿½åŠ ã—ã¾ã—ãŸ"
emoji: "ğŸŒŠ"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["GitBucket", "Scala", "Markdown"]
published: true
---
## æ¦‚è¦

[GitBucket](https://gitbucket.github.io/)ã®ãƒ—ãƒ©ã‚°ã‚¤ãƒ³[GitBucket Markdown Enhanced Plugin](https://github.com/yasumichi/gitbucket-markdown-enhanced)ã‚’é–‹ç™ºã—ã¦ã„ã¾ã™ã€‚

ä»Šå›ã¯ã€[Visual Studio Code](https://code.visualstudio.com/) ã®ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ [Markdown Preview Enhanced](https://shd101wyy.github.io/markdown-preview-enhanced/#/) ã®æ©Ÿèƒ½ã§ã‚ã‚‹ [Mark](https://shd101wyy.github.io/markdown-preview-enhanced/#/markdown-basics?id=mark) ã¨ã„ã†æ‹¡å¼µè¨˜æ³•ã«å¯¾å¿œã—ã¾ã—ãŸã€‚

```markdown
==Marked==
```

ã®ã‚ˆã†ã«æ›¸ãã¨

```html
<mark>Marked</mark>
```

å¤‰æ›ã•ã‚Œã‚‹æ©Ÿèƒ½ã§ã™ã€‚

## å‰å›ã®è¨˜äº‹

https://qiita.com/yasumichi/items/b3c2b2d0aaa03e2786af

Qiita ã ã‘ã©â€¦

## ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³è¨˜æ³•ã®ãƒ‘ãƒ¼ã‚¹å…ˆã®ãƒãƒ¼ãƒ‰ã‚’ç”¨æ„

[src\main\scala\io\github\yasumichi\gme\Mark.scala](https://github.com/yasumichi/gitbucket-markdown-enhanced/blob/9676b093a146f4b397673cf8e10a97d4e914c327/src/main/scala/io/github/yasumichi/gme/Mark.scala)

```scala
package io.github.yasumichi.gme

import com.vladsch.flexmark.util.ast.Node
import com.vladsch.flexmark.util.sequence.BasedSequence

class Mark(val text: BasedSequence, val source: BasedSequence) extends Node {
  override def getSegments: Array[BasedSequence] = Array(source)
}
```

## ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³ãƒ‘ãƒ¼ã‚µãƒ¼ã®ä½œæˆ

[src\main\scala\io\github\yasumichi\gme\MarkInlineParserExtension.scala](https://github.com/yasumichi/gitbucket-markdown-enhanced/blob/9676b093a146f4b397673cf8e10a97d4e914c327/src/main/scala/io/github/yasumichi/gme/MarkInlineParserExtension.scala)

```scala
package io.github.yasumichi.gme

import com.vladsch.flexmark.parser.{InlineParser, InlineParserExtension, InlineParserExtensionFactory, LightInlineParser}
import java.util
import java.util.regex.Pattern

class MarkInlineParserExtension() extends InlineParserExtension {
  override def finalizeDocument(inlineParser: InlineParser): Unit = {}
  override def finalizeBlock(inlineParser: InlineParser): Unit = {}
  override def parse(inlineParser: LightInlineParser): Boolean = {
    val patternText = """==(.+?)=="""
    val matches = inlineParser.matchWithGroups(Pattern.compile(patternText))
    if (matches != null) {
      inlineParser.flushTextNode()
      val markText = matches(1)
      inlineParser.getBlock.appendChild(new Mark(markText, matches(0)))
      return true
    }
    false
  }
}
object MarkInlineParserExtension {
  class Factory() extends InlineParserExtensionFactory {
    override def getCharacters: CharSequence = "="
    override def apply(inlineParser: LightInlineParser): InlineParserExtension = new MarkInlineParserExtension()
    override def getAfterDependents: util.Set[Class[_]] = null
    override def getBeforeDependents: util.Set[Class[_]] = null
    override def affectsGlobalScope(): Boolean = false
  }
}
```

MarkInlineParserExtension.Factory ã®

```scala
    override def getCharacters: CharSequence = "="
```

ã¨ã„ã†ãƒ¡ã‚½ãƒƒãƒ‰ã§ Mark ã®å…ˆé ­æ–‡å­— `=` ã‚’æŒ‡å®šã€‚

ã¾ãŸã€MarkInlineParserExtension.parse() ãƒ¡ã‚½ãƒƒãƒ‰ã®

```scala
    val patternText = """==(.+?)=="""
```

å‰å¾Œã« `==` ã§å›²ã¾ã‚ŒãŸæ–‡å­—åˆ—ã«ãƒãƒƒãƒã™ã‚‹ã‚ˆã†ã«æŒ‡å®šã—ã¦ã„ã¾ã™ã€‚

## ãƒãƒ¼ãƒ‰ãƒ¬ãƒ³ãƒ€ãƒ©ãƒ¼ã®ä½œæˆ

æ—¢å­˜ã® [MarkdownEnhancedNodeRenderer](https://github.com/yasumichi/gitbucket-markdown-enhanced/blob/9676b093a146f4b397673cf8e10a97d4e914c327/src/main/scala/io/github/yasumichi/gme/MarkdownEnhancedNodeRenderer.scala) ã«æ©Ÿèƒ½ã‚’è¿½åŠ ã™ã‚‹ã“ã¨ã«ã—ã¾ã—ãŸã€‚

MarkdownEnhancedNodeRenderer.getNodeRenderingHandlers() ãƒ¡ã‚½ãƒƒãƒ‰ãŒè¿”ã™ HashSet ã«ä»¥ä¸‹ã‚’è¿½åŠ ã—ã¾ã—ãŸã€‚

```scala
    set.add(
      new NodeRenderingHandler[Mark](
        classOf[Mark],
        this.renderMark
      )
    )
```

å®Ÿéš›ã® renderMark() ãƒ¡ã‚½ãƒƒãƒ‰ã¯ã€æ¬¡ã®ã‚ˆã†ã«å®Ÿè£…ã—ã¾ã—ãŸã€‚

```scala
  private def renderMark(
      node: Mark,
      context: NodeRendererContext,
      html: HtmlWriter
  ): Unit = {
    html.tag("mark")
    html.text(node.text.toString())
    html.tag("/mark")
  }
```

## æ‹¡å¼µã¸ã®è¿½åŠ 

æ—¢å­˜ã® [MarkdownEnhancedExtention](https://github.com/yasumichi/gitbucket-markdown-enhanced/blob/9676b093a146f4b397673cf8e10a97d4e914c327/src/main/scala/io/github/yasumichi/gme/MarkdownEnhancedExtention.scala) ã‚¯ãƒ©ã‚¹ã® extend() ãƒ¡ã‚½ãƒƒãƒ‰ã§å…ˆã»ã©ä½œæˆã—ãŸã‚¤ãƒ³ãƒ©ã‚¤ãƒ³ãƒ‘ãƒ¼ã‚µãƒ¼ã‚’ç™»éŒ²ã—ã¾ã™ã€‚

```scala
    override def extend(parserBuilder: Parser.Builder): Unit = {
      parserBuilder.customInlineParserExtensionFactory(new MarkInlineParserExtension.Factory())
    }
```

## ã‚¹ã‚¿ã‚¤ãƒ«ã®è¿½åŠ 

[src\main\resources\gme\assets\gme.css](https://github.com/yasumichi/gitbucket-markdown-enhanced/blob/9676b093a146f4b397673cf8e10a97d4e914c327/src/main/resources/gme/assets/gme.css) ã«ä»¥ä¸‹ã‚’è¿½åŠ ã—ã¾ã—ãŸã€‚

```css
mark {
    background-color: #fffd54;
    padding: 0;
}
```

## ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆ

ä»¥ä¸‹ã®ã‚ˆã†ã« `ãƒãƒ¼ã‚¯` ã®éƒ¨åˆ†ãŒå¼·èª¿è¡¨ç¤ºã•ã‚Œã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã—ãŸã€‚

![](https://storage.googleapis.com/zenn-user-upload/5efb3bf3b0a0-20251204.png)

## å‚è€ƒãƒªãƒ³ã‚¯

- [æ–°Markdownå°å…¥ã®èƒŒæ™¯ã¨ãã®å®Ÿè£…ã«ã¤ã„ã¦ | æ ªå¼ä¼šç¤¾ãƒŒãƒ¼ãƒ©ãƒœ(Nulab inc.)](https://nulab.com/ja/blog/nulab/new-markdown-implementation-background/)
